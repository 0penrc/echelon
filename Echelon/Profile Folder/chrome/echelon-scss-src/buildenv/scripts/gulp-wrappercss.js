var through = require("through2");
var File = require("vinyl");

module.exports = function(fileName)
{
    let files = [];

    return through.obj(
        function(file, encoding, callback)
        {
            // Collects the paths of incoming files and passes them through.
            files.push(file.relative.replace("\\", "/"));
            this.push(file);
            callback();
        },
        function(callback)
        {
            // Adds a new file at the end of the pipe with the specified filename.
            let output = new File();
            output.path = fileName;

            let content = (`
/*
 * This file is generated by the build system. All top-level files in the
 * echelon-scss-src/ directory are specified here automatically upon a
 * rebuild.
 *
 * Do not make direct changes to this file, as they will not be preserved.
 */
            `.trim() + "\n\n");

            for (let filePath of files)
            {
                if (filePath.indexOf("/") < 0)
                {
                    content += `@import url("${filePath}");\n`;
                }
            }

            output.contents = Buffer.from(content);
            this.push(output);
            callback();
        }
    );
};